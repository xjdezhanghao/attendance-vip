<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:include="include :: header('绩效考核统计')" />
    <title>绩效考核统计</title>
    <link type="text/css" th:href="@{/css/mobile.css}" rel="stylesheet"/>
</head>
<body>
    <div class="container">
        <h2 style="color: #4682b4;">绩效考核统计</h2>
        <form>
            <label>申请人:</label>
            <input type="text" th:value="#{kpi.createBy}" id="createBy" readonly>
            <label>申请时间:</label>
            <input type="text" th:value="#{kpi.createTime}" id="createTime" readonly>
            <label>申请部门:</label>
            <input type="text" th:value="#{kpi.deptName}" id="deptName" readonly>
            <label>汇总月份:</label>
            <input type="text" th:value="#{kpi.rectime}" id="rectime" readonly>
            <label>绩效奖励合计（元）:</label>
            <input type="text" th:value="#{kpi.jiangli}" id="jiangli" readonly>
            <label>绩效扣罚合计（元）:</label>
            <input type="text" th:value="#{kpi.koufa}" id="koufa" readonly>
            <div class="attachment">
                <label>附件:</label>
                <a href="javascript:viewFile();">点击查看附件</a>
            </div>
        </form>
        <div id="flowLine" class="process-nodes">
            <h3 style="color: #4682b4;">流程节点:</h3> <!-- 标题颜色为蓝色 -->
        </div>
        <div class="button-container">
            <button onclick="submit()" id="submitBtn" style="display: none" type="button">通过</button>
            <button onclick="back()" id="backBtn" class="cancel" style="display: none" type="button">退回</button>
        </div>
    </div>
</body>
<th:block th:include="include :: footer" />
<script th:src="@{/js/plugins/flowLine/mobile.min.js}"></script>
<script th:inline="javascript">
    var prefix = ctx + "financial/mobile";
    var finKpi = [[${finKpi}]];
    //流程操作标识
    var canOperate = [[${canOperate}]];
    //退回权限（高级别操作权限）
    var canBack = [[${canBack}]];
    //流程操作记录
    var recLines = [[${recLines}]];
    //终极节点标识（无需选择审批人）
    var hasFinal = [[${hasFinal}]];
    var conRecLines = [[${conRecLines}]];

    if (canOperate) {
        $("#submitBtn").show();
    }
    if (canOperate && canBack){
        $("#backBtn").show();
        $("#submitBtn").show();
    }

    if (!recLines){
        getUserNameByCode();
    }

    //基本信息
    $("#createBy").val(finKpi.createBy);
    $("#createTime").val(finKpi.createTime);
    $("#deptName").val(finKpi.deptName);
    $("#rectime").val(finKpi.rectime);
    $("#jiangli").val(finKpi.updateBy);
    $("#koufa").val(finKpi.remark);

    //流程图
    generateFlowLine(recLines, conRecLines, false);

    //提交审核
    function submit() {
        doSubmitFlow(ctx, recLines, conRecLines, finKpi, "绩效考核统计", hasFinal, function (res) {
            $("#submitBtn").hide();
            $("#backBtn").hide();
            generateFlowLine(recLines, conRecLines, true);
            $.modal.msgWarning("操作成功");
        });
    }

    //退回
    function back() {
        backHandler(ctx, recLines, conRecLines, finKpi, "绩效考核统计", hasFinal, function (res) {
            $("#submitBtn").hide();
            $("#backBtn").hide();
            conRecLines = res["conRecLines"];
            conRecLines.unshift({"operateBy":"申请人"});
            hasFinal = res["hasFinal"];
            generateFlowLine(recLines, conRecLines, true);
            $.modal.msgWarning("操作成功");
        })
    }

    //查看附件
    function viewFile() {
        downloadFile(finKpi, "kpi", function (result) {
            if (result.code == web_status.SUCCESS) {
                window.location.href = ctx + "common/download?fileName=" + encodeURI(result.msg) + "&delete=" + true;
            } else if (result.code == web_status.WARNING) {
                $.modal.alertWarning(result.msg)
            } else {
                $.modal.alertError(result.msg);
            }
        })
    }
</script>
</body>
</html>
