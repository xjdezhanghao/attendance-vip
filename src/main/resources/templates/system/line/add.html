<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增线性流程')" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-line-add">
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">流程名称：</label>
                <div class="col-sm-8">
                    <input name="flowname" class="form-control" type="text" autocomplete="off" required maxlength="64">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">流程节点：</label>
                <div class="col-sm-8">
                    <textarea id="flownode" name="flownode" class="form-control" type="text" placeholder="请在流程节点列表中进行操作" readonly required></textarea>
                    <input id="flowcode" name="flowcode" type="hidden" />
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label"></label>
                <div class="col-sm-8">
                    <div class="ibox">
                        <div class="ibox-content">
                            <h3>流程节点列表</h3>
                            <!--<p class="small"><i class="fa fa-hand-o-up"></i> 在列表之间拖动节点可进行排序</p>-->
                            <input id="treeId" name="treeId" type="hidden" th:value="${dept?.deptId}"   />
                            <div class="input-group">
                                <input id="flowNodeName" type="text" placeholder="添加新节点" class="input input-sm form-control" readonly>
                                <input id="flowNodeId" type="hidden" />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-sm btn-white" onclick="selectDeptTree()" > <i class="fa fa-hand-pointer-o"></i> 部门</button>
                                    <button type="button" class="btn btn-sm btn-white" onclick="selectPost()"> <i class="fa fa-hand-peace-o"></i> 岗位</button>
                                    <button type="button" class="btn btn-sm btn-white" onclick="addNode()"> <i class="fa fa-plus"></i> 添加</button>
                                </span>
                            </div>

                            <ul id="nodeList" class="sortable-list connectList agile-list">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <th:block th:include="include :: footer" />
    <script th:src="@{/js/jquery-ui-1.10.4.min.js}"></script>
    <script th:inline="javascript">
        var prefix = ctx + "system/line"
        var prefix2 = ctx + "system/dept"
        var prefix3 = ctx + "system/post"

        var nodeIdList = [];
        var nodeNameList = [];

        /*$(document).ready(function () {
            $(".sortable-list").sortable({connectWith: ".connectList"}).disableSelection()
        });*/

        $("#form-line-add").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                var flowcode = $("#flowcode").val();
                if (flowcode == null || flowcode.length == 0) {
                    $.modal.alertWarning("未添加节点");
                    return;
                }
                $.operate.save(prefix + "/add", $('#form-line-add').serialize());
            }
        }

        function selectDeptTree() {
            var treeId = $("#treeId").val();
            if ($.common.isEmpty(treeId)) {
                $.modal.alertWarning("未识别到用户所属部门，请重新登录！");
                return;
            }
            var options = {
                title: '部门选择',
                width: "380",
                url: prefix2 + "/selectDeptTree/" + treeId,
                callBack: doSubmit
            };
            $.modal.openOptions(options);
        }
        //确定部门
        function doSubmit(index, layero){
            var namestr = $("#flowNodeName").val();
            var idstr = $("#flowNodeId").val();
            var body = $.modal.getChildFrame(index);
            //部门名称连接
            if (namestr.indexOf("D") >= 0){
                if (namestr.indexOf("P") >= 0){
                    namestr = namestr.replace(namestr.substring(namestr.indexOf("D"), namestr.indexOf("P")), "D" + body.find('#treeName').val());
                } else {
                    namestr = "D" + body.find('#treeName').val();
                }
            }else {
                namestr = "D" + body.find('#treeName').val() + namestr;
            }
            $("#flowNodeName").val(namestr);
            //部门编码连接
            if (idstr.indexOf("D") >= 0){
                if (idstr.indexOf("P") >= 0){
                    idstr = idstr.replace(idstr.substring(idstr.indexOf("D"), idstr.indexOf("P")), "D" + body.find('#treeId').val());
                } else {
                    idstr = "D" + body.find('#treeId').val();
                }
            }else {
                idstr = "D" + body.find('#treeId').val() + idstr;
            }
            $("#flowNodeId").val(idstr);
            $.modal.close(index);
        }

        function selectPost() {
            var options = {
                title: '岗位选择',
                width: "380",
                height: "540",
                url: prefix3 + "/select",
                callBack: doSubmit2
            };
            $.modal.openOptions(options);
        }
        //确定岗位
        function doSubmit2(index, layero){
            var namestr = $("#flowNodeName").val();
            var idstr = $("#flowNodeId").val();

            var body = $.modal.getChildFrame(index);

            if (namestr.indexOf("P") >= 0){
                var tmp = namestr.substring(namestr.indexOf("P"), namestr.length);
                namestr = namestr.replace(namestr.substring(namestr.indexOf("P"), namestr.length), "P" + body.find('#postName').val());
            }else {
                namestr = namestr + "P" + body.find('#postName').val() ;
            }
            $("#flowNodeName").val(namestr);

            if (idstr.indexOf("P") >= 0){
                var tmp = idstr.substring(idstr.indexOf("P"), idstr.length);
                idstr = idstr.replace(idstr.substring(idstr.indexOf("P"), idstr.length), "P" + body.find('#postId').val());
            }else {
                idstr = idstr + "P" + body.find('#postId').val() ;
            }
            $("#flowNodeId").val(idstr);
            $.modal.close(index);
        }

        function addNode() {
            var idstr =  $("#flowNodeId").val();
            var namestr =  $("#flowNodeName").val();
            if (namestr.length == 0 || !(namestr.indexOf("P")>=0)) {
                $.modal.alertWarning("请选择部门与岗位");
                return;
            }
            nodeIdList.push(idstr);
            nodeNameList.push(namestr);
            for (var i=0; i<nodeNameList.length; i++){
                var htmlstr = '<li class="success-element">' + (i+1) + "：" + nodeNameList[i] + '</li>';
            }
            $("#nodeList").append(htmlstr);
            $("#flownode").val("");
            var tmp = nodeNameList.join(" -- ");
            $("#flownode").val(tmp);
            $("#flowcode").val("");
            tmp = nodeIdList.join("#");
            $("#flowcode").val(tmp);
            //置空
            $("#flowNodeName").val("");
            $("#flowNodeId").val("");
        }
        
    </script>
</body>
</html>