<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:include="include :: header('绩效采集详情')" />
  <style>
    .category-section {
      border: 1px solid #ddd;
      margin-bottom: 15px;
      border-radius: 5px;
    }
    .category-header {
      background-color: #f5f5f5;
      padding: 10px;
      font-weight: bold;
    }
    .score-input {

    }
    .remark-input {
      resize: vertical;
    }
    .image-upload {
      display: inline-block;
      margin-right: 10px;
    }
    .default-score {
      color: #999;
      font-size: 12px;
    }
    .tabs-container {
      margin-top: 20px;
    }
    .image-preview-area img {
      width: 80px;
      height: 60px;
      margin: 2px;
      object-fit: cover;
    }
    .score-range {
      font-size: 12px;
      color: #666;
      margin-left: 5px;
    }
    .category-total {
      font-weight: bold;
      color: #007bff;
    }
    .item-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .item-table th, .item-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .item-table th {
      background-color: #f2f2f2;
    }
    .item-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .thumbnail-img {
      width: 60px;
      height: 45px;
      object-fit: cover;
      cursor: pointer;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .image-preview-item {
      position: relative;
      display: inline-block;
    }

    .remove-image {
      position: absolute;
      top: -5px;
      right: -5px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: pointer;
      display: block;
      z-index: 10;
    }

    .image-preview-item:hover .remove-image {
      display: block;
    }
  </style>
</head>
<body class="white-bg">
<div class="main-content">
  <div class="row">
    <div class="col-sm-12">
      <div class="form-group">
        <label class="control-label">员工姓名：</label>
        <span th:text="${userParam.userName}"></span>
        &nbsp;&nbsp;
        <label class="control-label">部门：</label>
        <span th:text="${userParam.deptName}"></span>
        &nbsp;&nbsp;
        <label class="control-label">岗位：</label>
        <span th:text="${userParam.postName}"></span>
        &nbsp;&nbsp;
        <label class="control-label">采集日期：</label>
        <span th:text="${gatherDate}"></span>
      </div>
    </div>
  </div>

  <div class="tabs-container">
    <ul class="nav nav-tabs">
      <li th:each="overview,iterStat : ${overviewList}" th:class="${iterStat.index == 0} ? 'active'">
        <a data-toggle="tab" th:href="'#tab-' + ${iterStat.index}" th:text="${overview.deptName + overview.postName}"></a>
      </li>
    </ul>
    <div class="tab-content">
      <div th:each="overview,iterStat : ${overviewList}" th:id="'tab-' + ${iterStat.index}"
           th:class="${iterStat.index == 0} ? 'tab-pane active' : 'tab-pane'">
        <div class="panel-body">
          <form th:id="'form-' + ${overview.overviewId}">
            <input type="hidden" name="overviewId" th:value="${overview.overviewId}"/>

            <!-- 按大类分块展示具体的小项 -->
            <div th:if="${gatherDetailList.size() > iterStat.index}">
              <!-- 使用JavaScript处理数据分组 -->
              <div class="category-container" th:data-tab-index="${iterStat.index}">
                <!-- 分类容器将通过JavaScript动态生成 -->
              </div>

              <!-- 隐藏原始数据，供JavaScript处理 -->
              <div class="original-data" style="display:none;" th:id="'originalData_' + ${iterStat.index}">
                <div th:each="itemDetail : ${gatherDetailList[iterStat.index]}"
                     class="item-detail"
                     th:data-category-id="${itemDetail.categoryId}"
                     th:data-category-name="${itemDetail.categoryName}"
                     th:data-item-id="${itemDetail.itemId}"
                     th:data-item-name="${itemDetail.itemName}"
                     th:data-rule-desc="${itemDetail.ruleDesc}"
                     th:data-score-min="${itemDetail.scoreMin ?: 0}"
                     th:data-score-max="${itemDetail.scoreMax ?: 100}"
                     th:data-item-score="${itemDetail.itemScore}"
                     th:data-item-remark="${itemDetail.itemRemark}"
                     th:data-item-image-path="${itemDetail.imagePath}"
                     th:data-score-type="${itemDetail.scoreType}">  <!-- 添加图片路径 和 加减分类型 -->
                </div>
              </div>
            </div>

            <div class="row mt20">
              <div class="col-sm-12">
                <label class="control-label">总分: </label>
                <span th:id="'totalScore_' + ${overview.overviewId}" class="text-primary h4">0</span> 分
                <textarea class="form-control mt10"
                          th:name="'overallRemark_' + ${overview.overviewId}"
                          th:rows="3"
                          placeholder="整体评价备注..."
                          th:text="${overview.remark}"></textarea>
              </div>
            </div>

            <div class="row mt20">
              <div class="col-sm-12 text-center">
                <button type="button" class="btn btn-primary" th:onclick="|saveDetails(${overview.overviewId})|">保存</button>
                <button type="button" class="btn btn-default" onclick="closeItem()">关闭</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block th:include="include :: footer" />

<script>
  var prefix = ctx + "performance/gather";

  $(document).ready(function() {
    // 为每个标签页初始化内容和分数计算
    $('.tab-pane').each(function() {
      var tabIndex = $(this).attr('id').replace('tab-', '');
      var formId = $(this).find('form').attr('id');

      // 生成分类结构
      generateCategoryStructure(tabIndex, formId);

      // 初始化分数计算
      calculateTotalScore(formId);
      calculateCategoryScore(formId);
    });

    // 监听分数输入变化，实时计算总分和分类小计
    $(document).on('input', '.score-input', function() {
      var formId = $(this).closest('form').attr('id');
      calculateTotalScore(formId);
      calculateCategoryScore(formId);
    });
  });

  // 生成分类结构
  function generateCategoryStructure(tabIndex, formId) {
    var originalData = $('#originalData_' + tabIndex);
    var categoryContainer = $('#tab-' + tabIndex + ' .category-container');

    // 按分类ID分组数据
    var categoryMap = {};
    originalData.find('.item-detail').each(function() {
      var categoryId = $(this).data('category-id');
      var categoryName = $(this).data('category-name');

      if (!categoryMap[categoryId]) {
        categoryMap[categoryId] = {
          id: categoryId,
          name: categoryName,
          items: []
        };
      }

      categoryMap[categoryId].items.push({
        itemId: $(this).data('item-id'),
        itemName: $(this).data('item-name'),
        ruleDesc: $(this).data('rule-desc'),
        scoreMin: $(this).data('score-min'),
        scoreMax: $(this).data('score-max'),
        itemScore: $(this).data('item-score'),
        itemRemark: $(this).data('item-remark'),
        imagePath: $(this).data('item-image-path'),  // 添加图片路径
        scoreType: $(this).data('score-type')  // 添加分类加减分类型
      });
    });

    // 生成分类结构
    for (var categoryId in categoryMap) {
      var category = categoryMap[categoryId];
      var overviewId = $('#' + formId).find('input[name="overviewId"]').val();

      // 获取分类的scoreType（从第一个项目获取，因为同一分类下所有项目的scoreType应该相同）
      var categoryScoreType = category.items.length > 0 ? category.items[0].scoreType : '0';

      // 创建分类容器
      var categorySection = $('<div class="category-section" data-category-id="' + category.id + '" data-tab-index="' + tabIndex + '" data-score-type="' + categoryScoreType + '"></div>');
      
      // 根据scoreType显示分类类型
      var categoryTypeText = '';
      if (categoryScoreType === '1' || categoryScoreType === 1) {
        categoryTypeText = ' (加分项)';
      } else if (categoryScoreType === '2' || categoryScoreType === 2) {
        categoryTypeText = ' (减分项)';
      } else {
        categoryTypeText = ' (不加减分)';
      }
      
      var categoryHeader = $('<div class="category-header"><span>' + category.name + categoryTypeText + '</span><span class="pull-right">小计: <span class="category-total" id="categoryTotal_' + category.id + '_' + tabIndex + '">0</span> 分</span></div>');
      var categoryBody = $('<div class="category-body"></div>');

      // 创建表格
      var table = $('<table class="item-table" data-category-id="' + category.id + '"></table>');
      var thead = $('<thead><tr><th width="5%">名称</th><th width="45%">说明</th><th width="8%">单项分值</th><th width="6%">得分</th><th width="26%">备注</th><th width="10%">图片</th></tr></thead>');
      var tbody = $('<tbody></tbody>');

      // 添加表格行
      for (var i = 0; i < category.items.length; i++) {
        var item = category.items[i];
        var row = $('<tr></tr>');

        row.append('<td><label>' + item.itemName + '</label></td>');
        row.append('<td>' + (item.ruleDesc || '') + '</td>');
        row.append('<td>' + item.scoreMin + ' - ' + item.scoreMax + '</td>');

        var scoreCell = $('<td></td>');
        var scoreInput = $('<input type="text" class="form-control score-input" name="score_' + item.itemId + '" data-item-id="' + item.itemId + '" data-category-id="' + item.categoryId + '" data-overview-id="' + overviewId + '" placeholder="分数" value="' + (item.itemScore || '') + '"/>');
        scoreCell.append(scoreInput);
        row.append(scoreCell);

        var remarkCell = $('<td></td>');
        var remarkInput = $('<textarea class="form-control remark-input" name="remark_' + item.itemId + '" placeholder="备注" rows="2">' + (item.itemRemark || '') + '</textarea>');
        remarkCell.append(remarkInput);
        row.append(remarkCell);

        <!-- 在表格行中的图片列部分修改 -->
        var imageCell = $('<td></td>');
        var imageButton = $('<button type="button" class="btn btn-default btn-sm" onclick="uploadImage(this, ' + item.itemId + ', ' + overviewId + ')"><i class="fa fa-image"></i> 上传</button>');
        var imageArea = $('<div id="imageArea_' + item.itemId + '" class="image-preview-area"></div>');

        // 如果已有图片路径，则显示图片
        if (item.imagePath) {
          imageButton.hide(); // 隐藏上传按钮
          var previewHtml = '<div class="image-preview-item" data-image-path="' + item.imagePath + '">' +
                  '<img src="' + item.imagePath + '" alt="预览图" onclick="previewImage(this)" class="thumbnail-img"/>' +
                  '<span class="remove-image" onclick="removeImage(this)">×</span>' +
                  '<input type="hidden" name="image_' + item.itemId + '" value="' + item.imagePath + '"/>' +
                  '</div>';
          imageArea.html(previewHtml);
        }

        imageCell.append(imageButton).append(imageArea);
        row.append(imageCell);


        tbody.append(row);
      }

      table.append(thead).append(tbody);
      categoryBody.append(table);
      categorySection.append(categoryHeader).append(categoryBody);
      categoryContainer.append(categorySection);
    }
  }

  // 计算总分
  function calculateTotalScore(formId) {
    let total = 0;
    
    $('#' + formId + ' .score-input').each(function() {
      let score = parseFloat($(this).val()) || 0;
      
      // 获取当前输入框所在的分类容器
      var categorySection = $(this).closest('.category-section');
      var scoreType = categorySection.data('score-type');

      // 根据scoreType决定加减分
      // 0表示不加减分，1表示加分，2表示减分
      if (scoreType === '1' || scoreType === 1) {
        // 加分
        total += score;
      } else if (scoreType === '2' || scoreType === 2) {
        // 减分
        total -= score;
      }
      // scoreType为2时不加不减
    });

    var overviewId = $('#' + formId).find('input[name="overviewId"]').val();
    $('#totalScore_' + overviewId).text(total.toFixed(1));
  }

  // 计算分类小计
  function calculateCategoryScore(formId) {
    // 遍历每个分类表格，计算该分类下所有项目的得分总和
    $('#' + formId + ' .category-section').each(function() {
      var categoryId = $(this).data('category-id');
      var tabIndex = $(this).data('tab-index');
      var categoryTotal = 0;
      
      // 获取当前分类的加减分类型
      var scoreType = $(this).data('score-type');

      // 计算当前分类下所有得分
      $(this).find('.score-input').each(function() {
        var score = parseFloat($(this).val()) || 0;
        
        // 根据scoreType决定加减分
        // 0表示不加减分，1表示加分，2表示减分
        if (scoreType === '1' || scoreType === 1) {
          // 加分
          categoryTotal += score;
        } else if (scoreType === '2' || scoreType === 2) {
          // 减分
          categoryTotal -= score;
        }
        // scoreType为0时不加不减
      });

      // 更新分类小计显示
      $('#categoryTotal_' + categoryId + '_' + tabIndex).text(categoryTotal.toFixed(1));
    });
  }

  // 上传图片
  function uploadImage(btn, itemId, overviewId) {
    var input = $('<input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(this, ' + itemId + ', ' + overviewId + ')"/>');
    $('body').append(input);
    input.click();
  }

  // 处理图片上传
  function handleImageUpload(input, itemId, overviewId) {
    var files = input.files;
    if (files.length > 0) {
      var file = files[0];
      // 检查文件类型
      if (!file.type.startsWith('image/')) {
        $.modal.msgError("请选择图片文件");
        $(input).remove();
        return;
      }
      // 检查文件大小 (限制为5MB)
      if (file.size > 5 * 1024 * 1024) {
        $.modal.msgError("图片大小不能超过5MB");
        $(input).remove();
        return;
      }
      uploadSingleImage(file, itemId, overviewId);
    }
    $(input).remove();
  }

  // 单个图片上传
  function uploadSingleImage(file, itemId, overviewId) {
    var formData = new FormData();
    formData.append('file', file);

    $.ajax({
      url: ctx + 'common/upload',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(result) {
        if (result.code == 0) {
          console.info(result)
          // 隐藏上传按钮，显示图片预览
          var $imageArea = $('#imageArea_' + itemId);
          var $uploadBtn = $imageArea.siblings('button');

          $uploadBtn.hide();

          var previewHtml = '<div class="image-preview-item" data-image-path="' + result.fileName + '">' +
                  '<img src="' + result.fileName + '" alt="预览图" onclick="previewImage(this)" class="thumbnail-img"/>' +
                  '<span class="remove-image" onclick="removeImage(this)">×</span>' +
                  '<input type="hidden" name="image_' + itemId + '" value="' + result.fileName + '"/>' +
                  '</div>';

          $imageArea.html(previewHtml);
        } else {
          $.modal.alertError(result.msg);
        }
      },
      error: function() {
        $.modal.alertError("上传失败，请重试");
      }
    });
  }

  // 预览大图
  function previewImage(img) {
    var src = $(img).attr('src');
    var modalHtml = '<div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog">' +
            '<div class="modal-dialog modal-lg" role="document">' +
            '<div class="modal-content">' +
            '<div class="modal-header">' +
            '<h4 class="modal-title">图片预览</h4>' +
            '<button type="button" class="close" data-dismiss="modal">&times;</button>' +
            '</div>' +
            '<div class="modal-body text-center">' +
            '<img src="' + src + '" style="max-width: 100%; max-height: 70vh;"/>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

    $('body').append(modalHtml);
    $('#imagePreviewModal').modal('show');

    // 移除模态框后清理
    $('#imagePreviewModal').on('hidden.bs.modal', function () {
      $(this).remove();
    });
  }

  // 删除图片
  function removeImage(btn) {
    $.modal.confirm("确定要删除这张图片吗？", function (){
      var $previewItem = $(btn).closest('.image-preview-item');
      var $imageArea = $previewItem.parent();
      var $uploadBtn = $imageArea.siblings('button');

      $previewItem.remove();
      $uploadBtn.show(); // 显示上传按钮
    });
  }

  // 保存草稿
  // 保存所有标签页数据
  function saveDetails(overviewId) {
    var formData = new FormData();

    // 遍历所有表单，收集所有标签页的数据
    $('form').each(function() {
      var formId = $(this).attr('id');
      var currentOverviewId = $(this).find('input[name="overviewId"]').val();

      // 收集评分数据
      $('#' + formId + ' .score-input').each(function() {
        var itemId = $(this).data('item-id');
        var score = $(this).val();
        if (score !== '') {
          formData.append('scores[' + currentOverviewId + '][' + itemId + ']', score);
        }
      });

      // 收集备注数据
      $('#' + formId + ' .remark-input').each(function() {
        var name = $(this).attr('name');
        var itemId = name.replace('remark_', '');
        var remark = $(this).val();
        console.log("Remark:", name, "=", remark);
        if (remark !== '') {
          formData.append('remarks[' + currentOverviewId + '][' + itemId + ']', remark);
        }
      });

      // 收集图片路径
      $('#' + formId + ' input[name^="image_"]').each(function() {
        var name = $(this).attr('name');
        var itemId = name.replace('image_', '');
        var imagePath = $(this).val();
        if (imagePath !== '') {
          formData.append('imagePaths[' + currentOverviewId + '][' + itemId + ']', imagePath);
        }
      });

      // 整体备注
      var overallRemark = $('[name="overallRemark_' + currentOverviewId + '"]').val();
      if (overallRemark) {
        formData.append('overallRemarks[' + currentOverviewId + ']', overallRemark);
      }
    });

    // 调试：转换为普通对象查看内容
    var debugData = {};
    for (var pair of formData.entries()) {
      debugData[pair[0]] = pair[1];
    }
    console.log("FormData contents:", debugData);

    $.ajax({
      url: prefix + '/saveDetails',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(result) {
        if (result.code == 0) {
          $.modal.msgSuccess("保存成功");
        } else {
          $.modal.msgError(result.msg);
        }
      },
      error: function() {
        $.modal.msgError("保存失败，请重试");
      }
    });
  }


</script>
</body>
</html>
