<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('绩效统计图表')" />
    <th:block th:include="include :: datetimepicker-css" />
    <style>
        .dashboard-title {
            font-size: 16px;
            color: #1c2a3a;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .dashboard-subtitle {
            color: #8b97a5;
            font-size: 12px;
        }
        .chart-panel {
            height: 360px;
        }
        .chart-panel--large {
            height: 420px;
        }
        .kpi-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f6f8fb;
            border-radius: 6px;
            padding: 12px 16px;
        }
        .kpi-card h6 {
            margin: 0;
            font-size: 12px;
            color: #8b97a5;
        }
        .kpi-card .kpi-value {
            font-size: 18px;
            font-weight: 600;
            color: #1c2a3a;
        }
        .kpi-card .kpi-delta {
            font-size: 12px;
        }
        .kpi-delta--up {
            color: #1ab394;
        }
        .kpi-delta--down {
            color: #ed5565;
        }
        .kpi-delta--flat {
            color: #8b97a5;
        }
        .chart-filter {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }
        .chart-filter .input-group {
            width: 140px;
        }
        .chart-filter__sep {
            color: #8b97a5;
            font-size: 12px;
        }
        .chart-filter__btn {
            padding: 2px 8px;
        }
        .ibox-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
    </style>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="dashboard-title">绩效统计图表 <span class="dashboard-subtitle" id="dashboard-range">公司维度</span></div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>个人绩效TOP10</h5>
                    <div class="chart-filter" data-section="top-users">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="top-users-start" placeholder="开始日期">
                        </div>
                        <span class="chart-filter__sep">至</span>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="top-users-end" placeholder="结束日期">
                        </div>
                        <button type="button" class="btn btn-primary btn-xs chart-filter__btn" data-target="top-users">筛选</button>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="echarts-top-users" class="chart-panel"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>出勤时长TOP10</h5>
                    <div class="chart-filter" data-section="work-hours">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="work-hours-start" placeholder="开始日期">
                        </div>
                        <span class="chart-filter__sep">至</span>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="work-hours-end" placeholder="结束日期">
                        </div>
                        <button type="button" class="btn btn-primary btn-xs chart-filter__btn" data-target="work-hours">筛选</button>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="echarts-work-hours" class="chart-panel"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>绩效趋势</h5>
                    <div class="chart-filter" data-section="trend">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="trend-start" placeholder="开始日期">
                        </div>
                        <span class="chart-filter__sep">至</span>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="trend-end" placeholder="结束日期">
                        </div>
                        <button type="button" class="btn btn-primary btn-xs chart-filter__btn" data-target="trend">筛选</button>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="echarts-trend" class="chart-panel chart-panel--large"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>整体绩效画像</h5>
                    <div class="chart-filter" data-section="radar">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="radar-start" placeholder="开始日期">
                        </div>
                        <span class="chart-filter__sep">至</span>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control chart-date" id="radar-end" placeholder="结束日期">
                        </div>
                        <button type="button" class="btn btn-primary btn-xs chart-filter__btn" data-target="radar">筛选</button>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="echarts-radar" class="chart-panel"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: echarts-js" />
<th:block th:include="include :: datetimepicker-js" />
<script type="text/javascript">
    $(function () {
        var prefix = ctx + "performance/statistics";
        var workHoursChart = echarts.init(document.getElementById("echarts-work-hours"));
        var topUsersChart = echarts.init(document.getElementById("echarts-top-users"));
        var trendChart = echarts.init(document.getElementById("echarts-trend"));
        var radarChart = echarts.init(document.getElementById("echarts-radar"));
        var defaultRange = buildDefaultRange();
        var sectionDates = {
            "work-hours": { start: defaultRange.start, end: defaultRange.end },
            "top-users": { start: defaultRange.start, end: defaultRange.end },
            "trend": { start: defaultRange.start, end: defaultRange.end },
            "radar": { start: defaultRange.start, end: defaultRange.end }
        };

        function setLoading(charts, isLoading) {
            charts.forEach(function (chart) {
                if (isLoading) {
                    chart.showLoading();
                } else {
                    chart.hideLoading();
                }
            });
        }

        function buildDefaultRange() {
            var end = new Date();
            var start = new Date();
            start.setDate(end.getDate() - 29);
            return { start: formatDate(start), end: formatDate(end) };
        }

        function formatDate(date) {
            var year = date.getFullYear();
            var month = (date.getMonth() + 1).toString().padStart(2, "0");
            var day = date.getDate().toString().padStart(2, "0");
            return year + "-" + month + "-" + day;
        }

        function updateDashboardRange(startDate, endDate) {
            //$("#dashboard-range").text(startDate + " 至 " + endDate + "｜公司维度");
        }

        function renderWorkHours(topUsers) {
            var names = [];
            var hours = [];
            var reversedTopUsers = (topUsers || []).slice().reverse();
            (reversedTopUsers || []).forEach(function (item) {
                var deptName = item.deptName || "";
                names.push(item.userName + (deptName ? "｜" + deptName : ""));
                hours.push(item.workHours);
            });
            workHoursChart.setOption({
                tooltip: {
                    trigger: "axis",
                    axisPointer: { type: "shadow" },
                    formatter: function (params) {
                        var point = params[0];
                        if (!point) {
                            return "";
                        }
                        return point.name + "<br/>上班时长：" + point.value + " 小时";
                    }
                },
                grid: { left: 120, right: 30, top: 20, bottom: 20 },
                xAxis: {
                    type: "value",
                    axisLabel: { formatter: "{value}h" }
                },
                yAxis: {
                    type: "category",
                    data: names,
                    axisLabel: {
                        formatter: function (value) {
                            return value.length > 16 ? value.slice(0, 16) + "..." : value;
                        }
                    }
                },
                series: [{
                    name: "上班时长",
                    type: "bar",
                    barMaxWidth: 18,
                    itemStyle: { color: "#23c6c8" },
                    data: hours
                }]
            });
        }

        function renderTopUsers(topUsers) {
            var names = [];
            var scores = [];
            var reversedTopUsers = (topUsers || []).slice().reverse();
            (reversedTopUsers || []).forEach(function (item) {
                names.push(item.userName + "｜" + item.deptName);
                scores.push(item.score);
            });
            topUsersChart.setOption({
                tooltip: {
                    trigger: "axis",
                    axisPointer: { type: "shadow" }
                },
                grid: { left: 120, right: 30, top: 20, bottom: 20 },
                xAxis: {
                    type: "value",
                    axisLabel: { formatter: "{value}" }
                },
                yAxis: {
                    type: "category",
                    data: names,
                    axisLabel: {
                        formatter: function (value) {
                            return value.length > 16 ? value.slice(0, 16) + "..." : value;
                        }
                    }
                },
                series: [{
                    name: "分值",
                    type: "bar",
                    barMaxWidth: 18,
                    itemStyle: { color: "#1c84c6" },
                    data: scores
                }]
            });
        }

        function renderTrend(trend) {
            var series = [{
                name: "公司均值",
                type: "line",
                data: trend.companyAvg || [],
                lineStyle: { width: 3 },
                symbolSize: 6
            }];
            (trend.topDepts || []).forEach(function (dept) {
                series.push({
                    name: dept.deptName,
                    type: "line",
                    data: dept.avg,
                    lineStyle: { width: 1 },
                    symbolSize: 4
                });
            });
            trendChart.setOption({
                tooltip: { trigger: "axis" },
                legend: { data: series.map(function (item) { return item.name; }) },
                grid: { left: 50, right: 30, top: 40, bottom: 40 },
                xAxis: { type: "category", data: trend.dates || [] },
                yAxis: { type: "value" },
                series: series
            });
        }

        function renderRadar(radar) {
            var values = radar.values || [];
            var maxValue = Math.max.apply(null, values.filter(function (value) { return value !== null; }));
            if (!isFinite(maxValue)) {
                maxValue = 100;
            }
            var indicators = (radar.categories || []).map(function (name) {
                return { name: name, max: maxValue * 1.2 };
            });
            radarChart.setOption({
                tooltip: {},
                radar: { indicator: indicators, radius: "65%" },
                series: [{
                    type: "radar",
                    data: [{
                        value: values,
                        name: "公司能力画像",
                        areaStyle: { color: "rgba(28, 132, 198, 0.25)" },
                        lineStyle: { color: "#1c84c6" }
                    }]
                }]
            });
        }

        function fetchStatistics(sectionKey) {
            var range = sectionDates[sectionKey];
            if (!range) {
                return;
            }
            var targetCharts = [];
            if (sectionKey === "work-hours") {
                targetCharts = [workHoursChart];
            } else if (sectionKey === "top-users") {
                targetCharts = [topUsersChart];
            } else if (sectionKey === "trend") {
                targetCharts = [trendChart];
            } else if (sectionKey === "radar") {
                targetCharts = [radarChart];
            }
            setLoading(targetCharts, true);
            $.get(prefix + "/default", { startDate: range.start, endDate: range.end })
                .done(function (response) {
                    var payload = response.data || {};
                    if (sectionKey === "work-hours") {
                        renderWorkHours(payload.workHoursTop || []);
                        updateDashboardRange(range.start, range.end);
                    } else if (sectionKey === "top-users") {
                        renderTopUsers(payload.topUsers || []);
                    } else if (sectionKey === "trend") {
                        renderTrend(payload.trend || { dates: [], companyAvg: [], topDepts: [] });
                    } else if (sectionKey === "radar") {
                        renderRadar(payload.radar || { categories: [], values: [] });
                    }
                })
                .fail(function () {
                    if (sectionKey === "work-hours") {
                        renderWorkHours([]);
                    } else if (sectionKey === "top-users") {
                        renderTopUsers([]);
                    } else if (sectionKey === "trend") {
                        renderTrend({ dates: [], companyAvg: [], topDepts: [] });
                    } else if (sectionKey === "radar") {
                        renderRadar({ categories: [], values: [] });
                    }
                })
                .always(function () {
                    setLoading(targetCharts, false);
                });
        }

        function initDatePickers() {
            $(".chart-filter").each(function () {
                var section = $(this).data("section");
                var startId = "#" + section + "-start";
                var endId = "#" + section + "-end";
                $(startId).val(sectionDates[section].start);
                $(endId).val(sectionDates[section].end);
            });
            $(".chart-date").datetimepicker({
                format: "yyyy-mm-dd",
                minView: "month",
                autoclose: true
            });
        }

        function bindFilters() {
            $(".chart-filter__btn").on("click", function () {
                var section = $(this).data("target");
                var startValue = $("#" + section + "-start").val();
                var endValue = $("#" + section + "-end").val();
                if (startValue && endValue) {
                    sectionDates[section] = { start: startValue, end: endValue };
                    fetchStatistics(section);
                }
            });
        }

        initDatePickers();
        bindFilters();
        fetchStatistics("work-hours");
        fetchStatistics("top-users");
        fetchStatistics("trend");
        fetchStatistics("radar");

        $(window).on("resize", function () {
            workHoursChart.resize();
            topUsersChart.resize();
            trendChart.resize();
            radarChart.resize();
        });
    });
</script>
</body>
</html>
