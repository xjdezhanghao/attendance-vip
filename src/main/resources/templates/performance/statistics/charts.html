<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('绩效统计图表')" />
    <style>
        .dashboard-title {
            font-size: 16px;
            color: #1c2a3a;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .dashboard-subtitle {
            color: #8b97a5;
            font-size: 12px;
        }
        .chart-panel {
            height: 360px;
        }
        .chart-panel--large {
            height: 420px;
        }
        .kpi-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f6f8fb;
            border-radius: 6px;
            padding: 12px 16px;
        }
        .kpi-card h6 {
            margin: 0;
            font-size: 12px;
            color: #8b97a5;
        }
        .kpi-card .kpi-value {
            font-size: 18px;
            font-weight: 600;
            color: #1c2a3a;
        }
        .kpi-card .kpi-delta {
            font-size: 12px;
        }
        .kpi-delta--up {
            color: #1ab394;
        }
        .kpi-delta--down {
            color: #ed5565;
        }
        .kpi-delta--flat {
            color: #8b97a5;
        }
    </style>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="dashboard-title">绩效统计图表 <span class="dashboard-subtitle">近30天｜全公司</span></div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>公司均值指数</h5>
                </div>
                <div class="ibox-content">
                    <div id="echarts-gauge" class="chart-panel"></div>
                    <!--<div class="kpi-card" style="margin-top: 12px;">
                        <div>
                            <h6>较上周期</h6>
                            <div class="kpi-value" id="mom-delta">&#45;&#45;</div>
                        </div>
                        <div class="kpi-delta kpi-delta&#45;&#45;flat" id="mom-delta-pct">&#45;&#45;</div>
                    </div>-->
                </div>
            </div>
        </div>
        <div class="col-md-8 col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>个人Top10得分排行</h5>
                </div>
                <div class="ibox-content">
                    <div id="echarts-top-users" class="chart-panel"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>公司均值 + 前五部门均值得分趋势</h5>
                </div>
                <div class="ibox-content">
                    <div id="echarts-trend" class="chart-panel chart-panel--large"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>公司整体绩效能力画像</h5>
                </div>
                <div class="ibox-content">
                    <div id="echarts-radar" class="chart-panel"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: echarts-js" />
<script type="text/javascript">
    $(function () {
        var prefix = ctx + "performance/statistics";
        var gaugeChart = echarts.init(document.getElementById("echarts-gauge"));
        var topUsersChart = echarts.init(document.getElementById("echarts-top-users"));
        var trendChart = echarts.init(document.getElementById("echarts-trend"));
        var radarChart = echarts.init(document.getElementById("echarts-radar"));

        function setLoading(isLoading) {
            var charts = [gaugeChart, topUsersChart, trendChart, radarChart];
            charts.forEach(function (chart) {
                if (isLoading) {
                    chart.showLoading();
                } else {
                    chart.hideLoading();
                }
            });
        }

        function formatDelta(value) {
            if (value === null || value === undefined) {
                return "--";
            }
            var fixed = Number(value).toFixed(2);
            return (value > 0 ? "+" : "") + fixed;
        }

        function updateMomDelta(delta, deltaPct) {
            var $delta = $("#mom-delta");
            var $deltaPct = $("#mom-delta-pct");
            var className = "kpi-delta--flat";
            if (delta > 0) {
                className = "kpi-delta--up";
            } else if (delta < 0) {
                className = "kpi-delta--down";
            }
            $delta.text(formatDelta(delta));
            $deltaPct.text(deltaPct === null ? "--" : formatDelta(deltaPct) + "%");
            $deltaPct.removeClass("kpi-delta--up kpi-delta--down kpi-delta--flat").addClass(className);
        }

        function renderGauge(data, meta) {
            var bands = (meta && meta.gauge && meta.gauge.bands) ? meta.gauge.bands : [60, 80, 110, 150];
            var min = (meta && meta.gauge) ? meta.gauge.min : 0;
            var max = (meta && meta.gauge) ? meta.gauge.max : 160;
            var colors = [
                [bands[0] / max, "#ed5565"],
                [bands[1] / max, "#f8ac59"],
                [bands[2] / max, "#1c84c6"],
                [bands[3] / max, "#1ab394"],
                [1, "#23c6c8"]
            ];
            gaugeChart.setOption({
                tooltip: { formatter: "{a} <br/>{c}" },
                series: [{
                    name: "公司均值指数",
                    type: "gauge",
                    min: min,
                    max: max,
                    axisLine: {
                        lineStyle: {
                            width: 12,
                            color: colors
                        }
                    },
                    splitLine: { length: 12 },
                    axisTick: { length: 8 },
                    detail: {
                        fontSize: 20,
                        formatter: function (value) {
                            return value.toFixed(1);
                        }
                    },
                    data: [{ value: data.companyAvgScore || 0, name: "指数" }]
                }]
            });
        }

        function renderTopUsers(topUsers) {
            var names = [];
            var scores = [];
            (topUsers || []).forEach(function (item) {
                names.push(item.userName + "｜" + item.deptName);
                scores.push(item.score);
            });
            topUsersChart.setOption({
                tooltip: {
                    trigger: "axis",
                    axisPointer: { type: "shadow" }
                },
                grid: { left: 120, right: 30, top: 20, bottom: 20 },
                xAxis: {
                    type: "value",
                    axisLabel: { formatter: "{value}" }
                },
                yAxis: {
                    type: "category",
                    data: names,
                    axisLabel: {
                        formatter: function (value) {
                            return value.length > 16 ? value.slice(0, 16) + "..." : value;
                        }
                    }
                },
                series: [{
                    name: "得分",
                    type: "bar",
                    barMaxWidth: 18,
                    itemStyle: { color: "#1c84c6" },
                    data: scores
                }]
            });
        }

        function renderTrend(trend) {
            var series = [{
                name: "公司均值",
                type: "line",
                data: trend.companyAvg || [],
                lineStyle: { width: 3 },
                symbolSize: 6
            }];
            (trend.topDepts || []).forEach(function (dept) {
                series.push({
                    name: dept.deptName,
                    type: "line",
                    data: dept.avg,
                    lineStyle: { width: 1 },
                    symbolSize: 4
                });
            });
            trendChart.setOption({
                tooltip: { trigger: "axis" },
                legend: { data: series.map(function (item) { return item.name; }) },
                grid: { left: 50, right: 30, top: 40, bottom: 40 },
                xAxis: { type: "category", data: trend.dates || [] },
                yAxis: { type: "value" },
                series: series
            });
        }

        function renderRadar(radar) {
            var values = radar.values || [];
            var maxValue = Math.max.apply(null, values.filter(function (value) { return value !== null; }));
            if (!isFinite(maxValue)) {
                maxValue = 100;
            }
            var indicators = (radar.categories || []).map(function (name) {
                return { name: name, max: maxValue * 1.2 };
            });
            radarChart.setOption({
                tooltip: {},
                radar: { indicator: indicators, radius: "65%" },
                series: [{
                    type: "radar",
                    data: [{
                        value: values,
                        name: "公司能力画像",
                        areaStyle: { color: "rgba(28, 132, 198, 0.25)" },
                        lineStyle: { color: "#1c84c6" }
                    }]
                }]
            });
        }

        setLoading(true);
        $.get(prefix + "/default")
            .done(function (response) {
                var payload = response.data || {};
                renderGauge(payload.gauge || {}, payload.meta || {});
                renderTopUsers(payload.topUsers || []);
                renderTrend(payload.trend || { dates: [], companyAvg: [], topDepts: [] });
                renderRadar(payload.radar || { categories: [], values: [] });
                updateMomDelta(payload.gauge.momDelta || 0, payload.gauge.momDeltaPct);
            })
            .fail(function () {
                renderGauge({ companyAvgScore: 0 }, { gauge: { min: 0, max: 160, bands: [60, 80, 110, 150] } });
                renderTopUsers([]);
                renderTrend({ dates: [], companyAvg: [], topDepts: [] });
                renderRadar({ categories: [], values: [] });
                updateMomDelta(0, null);
            })
            .always(function () {
                setLoading(false);
            });

        $(window).on("resize", function () {
            gaugeChart.resize();
            topUsersChart.resize();
            trendChart.resize();
            radarChart.resize();
        });
    });
</script>
</body>
</html>
