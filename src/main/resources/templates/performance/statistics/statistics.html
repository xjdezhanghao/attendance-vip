
<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('绩效统计')" />
    <th:block th:include="include :: layout-latest-css" />
    <th:block th:include="include :: ztree-css" />
    <th:block th:include="include :: datetimepicker-css" />
    <th:block th:include="include :: select2-css" />
    <style>
        .month-picker {
            width: 20px !important;
        }
        .month-picker .input-group-addon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="gray-bg">
<div class="ui-layout-west">
    <div class="box box-main">
        <div class="box-header">
            <div class="box-title">
                <i class="fa icon-grid"></i> 组织机构
            </div>
            <div class="box-tools pull-right">
                <a type="button" class="btn btn-box-tool" href="#" onclick="dept()" title="管理部门"><i class="fa fa-edit"></i></a>
                <button type="button" class="btn btn-box-tool" id="btnExpand" title="展开" style="display:none;"><i class="fa fa-chevron-up"></i></button>
                <button type="button" class="btn btn-box-tool" id="btnCollapse" title="折叠"><i class="fa fa-chevron-down"></i></button>
                <button type="button" class="btn btn-box-tool" id="btnRefresh" title="刷新部门"><i class="fa fa-refresh"></i></button>
            </div>
        </div>
        <div class="ui-layout-content">
            <div id="tree" class="ztree"></div>
        </div>
    </div>
</div>

<div class="ui-layout-center">
    <div class="container-div">
        <div class="row">
            <div class="col-sm-12 search-collapse">
                <form id="user-form">
                    <input type="hidden" id="deptId" name="deptId">
                    <input type="hidden" id="parentId" name="parentId">
                    <div class="select-list">
                        <ul>
                            <li style="display: flex; align-items: center;">
                                <span style="margin-right: 5px;">开始日期：</span>
                                <div class="input-group date">
                                    <span class="month-picker input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" class="form-control" id="startDate" name="startDate"
                                           th:value="${defaultStartDate}"
                                           placeholder="选择日期" style="width: 120px;">
                                </div>
                            </li>
                            <li style="display: flex; align-items: center;">
                                <span style="margin-right: 5px;">结束日期：</span>
                                <div class="input-group date">
                                    <span class="month-picker input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" class="form-control" id="endDate" name="endDate"
                                           th:value="${defaultEndDate}"
                                           placeholder="选择日期" style="width: 120px;">
                                </div>
                            </li>
                            <li>
                                员工姓名：<input type="text" name="userName"/>
                            </li>
                            <li>
                                岗位：<select name="postId" id="postIdSelect" class="form-control">
                                <option value="">请选择岗位</option>
                            </select>
                            </li>
                            <li>
                                <a class="btn btn-primary btn-rounded btn-sm"  onclick="customSearch()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                <a class="btn btn-warning btn-rounded btn-sm" onclick="customReset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                                <a class="btn btn-info btn-rounded btn-sm" onclick="viewCharts()"><i class="fa fa-table"></i>&nbsp;可视化</a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>

            <!-- 在表格上方添加工具栏 -->
            <div class="col-sm-12 mb-2">
                <div id="toolbar" class="btn-group-sm" role="group">
                    <!-- 返回按钮将动态添加到这里 -->
                </div>
            </div>

            <div class="col-sm-12 select-table table-striped">
                <table id="bootstrap-table"></table>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: layout-latest-js" />
<th:block th:include="include :: ztree-js" />
<th:block th:include="include :: datetimepicker-js" />
<th:block th:include="include :: select2-js" />
<script th:inline="javascript">
    var editFlag = [[${@permission.hasPermi('perf:stat:edit')}]];
    var removeFlag = [[${@permission.hasPermi('perf:stat:remove')}]];
    var prefix = ctx + "performance/statistics";

    var ranks = [[${@dict.getType('perf_rank_type')}]];
    var posts = [[${@dict.getType('perf_post_type')}]];

    // 存储原始查询条件的字典
    var originalSearchConditions = {};
    // 返回按钮状态标志
    var hasStoredConditions = false;
    // 存储表格配置选项
    var tableOptions = null;
    // 内层表格URL
    var url2 = prefix + "/list2";

    $(function() {
        // 初始化日期选择器
        $("#startDate").datetimepicker({
            format: "yyyy-mm-dd",
            minView: "month",
            //maxView: "decade",
            autoclose: true,
            //startView: 3,  // 从年视图开始
            minViewMode: 2 // 月份模式
        });
        // 初始化日期选择器
        $("#endDate").datetimepicker({
            format: "yyyy-mm-dd",
            minView: "month",
            //maxView: "decade",
            autoclose: true,
            //startView: 3,  // 从年视图开始
            minViewMode: 2 // 月份模式
        });

        var panehHidden = false;
        if ($(this).width() < 769) {
            panehHidden = true;
        }
        $('body').layout({ initClosed: panehHidden, west__size: 185 });
        // 回到顶部绑定
        if ($.fn.toTop !== undefined) {
            var opt = {
                win:$('.ui-layout-center'),
                doc:$('.ui-layout-center')
            };
            $('#scroll-up').toTop(opt);
        }
        loadPostData();
        queryUserList();
        queryDeptTree();
    });


    function loadPostData() {
        $.get(ctx + "performance/post/list2", function(result) {
            if (result.code === 0) {
                var postOptions = '<option value="">请选择岗位</option>';
                $.each(result.rows, function(index, item) {
                    postOptions += '<option value="' + item.postId + '">' + item.postName + '</option>';
                });
                $("#postIdSelect").html(postOptions);
            }
        });
    }

    function queryUserList() {
        var options = {
            url: prefix + "/list",
            createUrl: prefix + "/add",
            importUrl: prefix + "/importData",
            removeUrl: prefix + "/remove",
            exportUrl: prefix + "/export",
            modalName: "绩效统计",
            onLoadSuccess: function(data) {
                // 表格加载成功后的回调
                // 如果不是从onScoreClick触发的状态，则隐藏返回按钮
                if(!hasStoredConditions) {
                    hideReturnButton();
                }
            },
            columns: [{
                checkbox: false,
                visible: false
            },
                /*{
                    field: 'overviewId',
                    title: '采集记录ID',
                    visible: false
                },*/
                {
                    field: 'userId',
                    title: '员工ID',
                    visible: false
                },
                {
                    field: 'userName',
                    title: '员工姓名'
                },
                {
                    field: 'deptId',
                    title: '部门ID',
                    visible: false
                },
                {
                    field: 'deptName',
                    title: '所属单位'
                },
                {
                    field: 'postName',
                    title: '岗位'
                },
                {
                    field: 'postId',
                    title: '岗位ID',
                    visible: false
                },
                /*{
                    field: 'projectName',
                    title: '考核项目'
                },*/
                {
                    field: 'gatherDate',
                    title: '采集日期'
                },
                {
                    field: 'totalScore',
                    title: '考核得分',
                    sortable: true,
                    formatter: function(value, row, index) {
                        var displayValue = hasStoredConditions ? value : (100 + value);
                        return '<span onclick="onScoreClick(' + JSON.stringify(row).replace(/"/g, '&quot;') + ')" style="cursor: pointer; color: #1a7bb9">' +
                            displayValue + '</span>';
                    }
                },
                /*{
                    field: 'gatherStatusName',
                    title: '采集状态'
                },*/
                {
                    title: '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="overviewDetail(\''+row.userId+'\',\''+row.gatherDate+'\',\''+row.userName+'\')"><i class="fa fa-edit"></i>查看</a> ');
                        return actions.join('');
                    }
                }]
        };
        // 保存表格选项
        tableOptions = options;
        $.table.init(options);
    }

    // 处理得分列点击事件
    function onScoreClick(rowData) {
        if (hasStoredConditions) {
            overviewDetail(rowData.userId, rowData.gatherDate, rowData.userName);
            return;
        }
        // 保存当前的查询条件
        saveCurrentSearchConditions();
        // 构建查询参数 - 使用原始查询条件加上当前行的userId
        var queryParams = {};
        // 复制原始查询条件
        for (var key in originalSearchConditions) {
            if (originalSearchConditions.hasOwnProperty(key)) {
                queryParams[key] = originalSearchConditions[key];
            }
        }
        // 添加当前行的userId
        queryParams['userId'] = rowData.userId;
        // 发起新的查询请求
        ajaxTable(queryParams, url2);
        // 显示返回按钮
        showReturnButton();
    }

    // 保存当前查询条件
    function saveCurrentSearchConditions() {
        // 获取当前表单中的所有值并存储到字典中
        $("#user-form").find('input[name], select[name]').each(function() {
            var fieldName = $(this).attr('name');
            var fieldValue = $(this).val();
            originalSearchConditions[fieldName] = fieldValue;
        });
        console.log('保存的查询条件:', originalSearchConditions);
        // 设置标志为true
        hasStoredConditions = true;
    }
    // 显示返回按钮
    function showReturnButton() {
        // 如果返回按钮不存在，则创建它
        if ($("#returnBtn").length === 0) {
            var returnButtonHtml = '<a id="returnBtn" class="btn btn-default btn-rounded btn-sm" style="display:none;" onclick="returnToOriginalSearch()"><i class="fa fa-arrow-left"></i>&nbsp;返回</a>';
            // 将按钮插入到表格工具栏中
            var toolbar = $("#toolbar");
            if (toolbar.length === 0) {
                // 如果没有toolbar div，创建一个
                toolbar = $('<div id="toolbar" class="btn-group-sm mb-3" role="group"></div>');
                $("#bootstrap-table").before(toolbar);
            }
            toolbar.prepend(returnButtonHtml);
        }
        // 显示按钮
        $("#returnBtn").show();
    }
    // 隐藏返回按钮
    function hideReturnButton() {
        $("#returnBtn").hide();
    }
    // 返回到原始搜索条件
    function returnToOriginalSearch() {
        // 恢复原始查询条件
        for (var fieldName in originalSearchConditions) {
            if (originalSearchConditions.hasOwnProperty(fieldName)) {
                $("[name='" + fieldName + "']").val(originalSearchConditions[fieldName]);
            }
        }
        // 清空存储的条件
        originalSearchConditions = {};
        hasStoredConditions = false;
        // 隐藏返回按钮
        hideReturnButton();
        // 使用原始查询条件重新发起搜索
        var originalQueryParams = {};
        $("#user-form").find('input[name], select[name]').each(function() {
            var fieldName = $(this).attr('name');
            var fieldValue = $(this).val();
            if(fieldValue) { // 只添加非空值
                originalQueryParams[fieldName] = fieldValue;
            }
        });
        // 发起原始查询请求
        ajaxTable(originalQueryParams, tableOptions.url);
    }
    // 重置查询条件存储状态
    function resetSearchConditionStorage() {
        if (hasStoredConditions) {
            originalSearchConditions = {};
            hasStoredConditions = false;
            hideReturnButton();
        }
    }

    // 替换原来的搜索按钮行为
    function customSearch() {
        resetSearchConditionStorage();
        // 使用表单中的值发起查询
        var queryParams = {};
        $("#user-form").find('input[name], select[name]').each(function() {
            var fieldName = $(this).attr('name');
            var fieldValue = $(this).val();
            if(fieldValue) { // 只添加非空值
                queryParams[fieldName] = fieldValue;
            }
        });
        ajaxTable(queryParams, tableOptions.url);
    }

    // 替换原来的重置按钮行为
    function customReset() {
        resetSearchConditionStorage();
        $.form.reset();
        ajaxTable({}, tableOptions.url);
    }

    function ajaxTable(queryParams, url) {
        // 发起原始查询请求
        $.ajax({
            url: url,
            type: 'POST',
            data: queryParams,
            success: function(result) {
                if (result.code === 0) {
                    // 准备表格数据
                    var tableData = {
                        total: result.total || result.rows.length,
                        rows: result.rows
                    };
                    // 使用 load 方法加载数据，这会自动更新分页信息
                    $('#bootstrap-table').bootstrapTable('load', tableData);
                } else {
                    alert('查询失败: ' + result.msg);
                }
            },
            error: function() {
                alert('查询失败，请检查网络连接');
            }
        });
    }

    function queryDeptTree()
    {
        var url = ctx + "system/dept/treeData";
        var options = {
            url: url,
            expandLevel: 2,
            onClick : zOnClick
        };
        $.tree.init(options);

        function zOnClick(event, treeId, treeNode) {
            $("#deptId").val(treeNode.id);
            $("#parentId").val(treeNode.pId);
            $.table.search();
        }
    }

    $('#btnExpand').click(function() {
        $._tree.expandAll(true);
        $(this).hide();
        $('#btnCollapse').show();
    });

    $('#btnCollapse').click(function() {
        $._tree.expandAll(false);
        $(this).hide();
        $('#btnExpand').show();
    });

    $('#btnRefresh').click(function() {
        queryDeptTree();
    });

    /* 用户管理-部门 */
    function dept() {
        var url = ctx + "system/dept";
        $.modal.openTab("部门管理", url);
    }

    function overviewDetail(userId,gatherDate,userName){
        var startDate, endDate;
        // 检查gatherDate是否包含"-"
        if (gatherDate && gatherDate.includes(" - ")) {
            // 分割日期字符串
            var dateParts = gatherDate.split(" - ");
            startDate = dateParts[0];
            endDate = dateParts[1];
        } else {
            startDate = gatherDate;
            endDate = gatherDate;
        }
        // 构建URL参数
        var url = prefix + "/overviewDetail?userId=" + userId + "&startDate=" + startDate + "&endDate=" + endDate;
        $.modal.openTab("绩效采集：" + userName, url);
    }

    function viewCharts(){
        $.modal.openTab("绩效统计可视化", prefix + "/charts");

    }
</script>
</body>
<!-- 导入区域 -->
<script id="importTpl" type="text/template">    <form enctype="multipart/form-data" class="mt20 mb10">
    <div class="col-xs-offset-1">
        <input type="file" id="file" name="file"/>
        <div class="mt10 pt5"></div>
        <font color="red" class="pull-left mt10">
            提示：仅允许导入"xls"或"xlsx"格式文件！
        </font>
    </div>
</form>
</script>
</html>