<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('编辑考核项目')" />
    <th:block th:include="include :: select2-css" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-project-edit">
        <input name="projectId" type="hidden" id="projectId">

        <h4 class="form-header h4">基础信息配置</h4>
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">适用组织：</label>
            <div class="col-sm-8">
                <div class="input-group">
                    <input class="form-control" type="text" id="deptName" readonly required>
                    <input type="hidden" id="deptId" name="deptId">
                    <span class="input-group-addon"><i class="fa fa-search"></i></span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label is-required">适用岗位：</label>
            <div class="col-sm-8">
                <select name="postId" id="postId" class="form-control select2" required>
                    <option value="">请选择岗位</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label is-required">项目名称：</label>
            <div class="col-sm-8">
                <input name="projectName" id="projectName" class="form-control" type="text" required>
            </div>
        </div>

        <h4 class="form-header h4">大类配置</h4>
        <div class="form-group">
            <div class="col-sm-8">
                <button type="button" class="btn btn-primary btn-sm" onclick="addCategory()">
                    <i class="fa fa-plus"></i> 新增大类
                </button>
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-12">
                <table class="table table-bordered" id="category-table" style="width: 100%">
                    <thead>
                    <tr>
                        <th width="5%">序号</th>
                        <th width="20%">大类名称</th>
                        <th width="15%">加减分类型</th>
                        <th width="10%">权重</th>
                        <th width="20%">操作</th>
                    </tr>
                    </thead>
                    <tbody id="category-tbody">
                    <!-- 动态添加的大类 -->
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</div>

<!--<div class="row">
    <div class="col-sm-offset-5 col-sm-10">
        <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler()">
            <i class="fa fa-check"></i> 保存
        </button>&nbsp;
        <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()">
            <i class="fa fa-reply-all"></i> 关闭
        </button>
    </div>
</div>-->

<th:block th:include="include :: footer" />
<th:block th:include="include :: select2-js" />

<script th:inline="javascript">
    var prefix = ctx + "performance/indicator";
    var categoryIndex = 0;
    var editInit = true;

    $(document).ready(function() {
        // 初始化岗位下拉框
        initPostSelect();

        // 部门选择事件
        $('#deptName').click(function() {
            selectDeptTree();
        });

        // 岗位选择事件
        $('#postId').on('change', function() {
            generateProjectName();
        });

        // 禁用表单的自动填充功能
        $('input, select').attr('autocomplete', 'off');

        // 检查是否有编辑数据，初始化页面
        initializeEditData();
    });

    // 初始化岗位下拉框
    function initPostSelect() {
        $.ajax({
            url: ctx + "performance/post/list2",
            type: "get",
            success: function(result) {
                if (result.code == 0) {
                    var options = '<option value="">请选择岗位</option>';
                    $.each(result.rows, function(index, item) {
                        options += '<option value="' + item.postId + '">' + item.postName + '</option>';
                    });
                    $('#postId').html(options).select2({
                        placeholder: "请选择岗位",
                        allowClear: true
                    });
                }
            }
        });
    }

    // 选择部门树
    function selectDeptTree() {
        var deptId = $.common.isEmpty($("#deptId").val()) ? "100" : $("#deptId").val();
        var url = ctx + "system/dept/selectDeptTree/" + deptId;
        var options = {
            title: '选择部门',
            width: "380",
            url: url,
            callBack: doSubmitDept
        };
        $.modal.openOptions(options);
    }

    function doSubmitDept(index, layero) {
        var body = $.modal.getChildFrame(index);
        $("#deptId").val(body.find('#treeId').val());
        $("#deptName").val(body.find('#treeName').val());
        $.modal.close(index);
        generateProjectName();
    }

    // 自动生成项目名称
    function generateProjectName() {
        var deptName = $('#deptName').val();
        var postName = $('#postId option:selected').text();

        if (deptName && postName && postName !== '请选择岗位' && editInit) {
            var projectName = deptName + postName + '月度考核';
            $('#projectName').val(projectName);
        }
    }

    // 新增大类
    function addCategory() {
        categoryIndex++;
        var html = `
                <tr id="category-row-${categoryIndex}">
                    <td>${categoryIndex}</td>
                    <td><input type="text" class="form-control" name="categoryName" placeholder="请输入大类名称" required autocomplete="off"></td>
                    <td>
                        <select class="form-control" name="scoreType" autocomplete="off">
                            <option value="1">加分</option>
                            <option value="2">减分</option>
                            <option value="3">不加减分</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-control" name="weight" min="0" max="100" placeholder="权重" value="1" autocomplete="off"></td>
                    <td>
                        <input type="hidden" name="sort" value="${categoryIndex}">
                        <button type="button" class="btn btn-info btn-xs" onclick="configItems(${categoryIndex})">
                            <i class="fa fa-cog"></i> 配置小项
                        </button>
                        <button type="button" class="btn btn-success btn-xs" onclick="moveUp(${categoryIndex})">
                            <i class="fa fa-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-warning btn-xs" onclick="moveDown(${categoryIndex})">
                            <i class="fa fa-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-xs" onclick="deleteCategory(${categoryIndex})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        $('#category-tbody').append(html);
    }

    // 配置小项
    function configItems(categoryIndex) {
        var categoryName = $(`#category-row-${categoryIndex} input[name='categoryName']`).val();
        if (!categoryName) {
            $.modal.alertWarning("请先填写大类名称");
            return;
        }
        console.info("配置小项 - " + categoryName);
        // 获取当前弹窗的 layer 索引
        var layerIndex = parent.layer.getFrameIndex(window.name);
        // 获取已有的小项数据
        var existingItems = getCategoryItems(categoryIndex);

        var url = prefix + "/addItem?categoryIndex=" + categoryIndex + "&layerIndex=" + layerIndex;
        var options = {
            title: '配置小项 - ' + categoryName,
            width: "800",
            height: "600",
            url: url,
            callBack: function(index, layero) {
                // 可以在这里处理回调
                layero.find("iframe")[0].contentWindow.saveItems();
            }
        };
        $.modal.openOptions(options);
    }

    // 上移
    function moveUp(categoryIndex) {
        var currentRow = $('#category-row-' + categoryIndex);
        var prevRow = currentRow.prev();
        if (prevRow.length > 0) {
            currentRow.insertBefore(prevRow);
            reOrderCategories();
        }
    }

    // 下移
    function moveDown(categoryIndex) {
        var currentRow = $('#category-row-' + categoryIndex);
        var nextRow = currentRow.next();
        if (nextRow.length > 0) {
            currentRow.insertAfter(nextRow);
            reOrderCategories();
        }
    }

    // 重新排序
    function reOrderCategories() {
        $('#category-tbody tr').each(function(index) {
            var newIndex = index + 1;
            // 更新序号
            $(this).find('td:first').text(newIndex);
            var id = $(this).attr('id');
            var newIndex = index + 1;
            $(this).attr('id', id.replace(/\d+$/, newIndex));
            // 更新排序隐藏字段
            $(this).find('input[name="sort"]').val(newIndex);
            // 更新按钮事件参数
            $(this).find('button[onclick*="configItems"]').attr('onclick', 'configItems(' + newIndex + ')');
            $(this).find('button[onclick*="moveUp"]').attr('onclick', 'moveUp(' + newIndex + ')');
            $(this).find('button[onclick*="moveDown"]').attr('onclick', 'moveDown(' + newIndex + ')');
            $(this).find('button[onclick*="deleteCategory"]').attr('onclick', 'deleteCategory(' + newIndex + ')');
        });
    }

    // 删除大类
    function deleteCategory(categoryIndex) {
        $.modal.confirm("确认要删除该大类吗？", function() {
            $('#category-row-' + categoryIndex).remove();
            reOrderCategories();
        });
    }

    // 提交表单
    function submitHandler() {
        if (!$.validate.form("form-project-edit")) {
            return;
        }

        var projectId = $('#projectId').val();
        var url = projectId ? (prefix + "/edit") : (prefix + "/add");

        var data = {
            projectId: projectId || null,
            deptId: $('#deptId').val(),
            postId: $('#postId').val(),
            projectName: $('#projectName').val(),
            categories: []
        };

        // 收集大类数据和对应的小项数据
        $('#category-tbody tr').each(function(index) {
            var categoryIndex = index + 1;
            var category = {
                categoryName: $(this).find("input[name='categoryName']").val(),
                scoreType: $(this).find("select[name='scoreType']").val(),
                weight: $(this).find("input[name='weight']").val(),
                sort: $(this).find("input[name='sort']").val(), // 添加排序字段
                items: getCategoryItems(categoryIndex) // 获取对应的小项数据
            };
            data.categories.push(category);
        });

        $.ajax({
            url: url,
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            success: function(result) {
                if (result.code == 0) {
                    closeItem();
                    parent.$.modal.msgSuccess("保存成功");
                    parent.$.modal.reload();
                } else {
                    $.modal.alertError(result.msg);
                }
            },
            error: function(error) {
                $.modal.alertError("请求失败：" + error.responseText);
            }
        });
    }

    // 关闭页面
    function closeItem() {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }

    // 接收子页面传来的小项数据
    function setCategoryItems(categoryIndex, items) {
        // 将小项数据存储到对应的大类行中
        var categoryRow = $('#category-row-' + categoryIndex);
        if (categoryRow.length > 0) {
            // 在行中存储小项数据
            categoryRow.data('items', items);
            // 更新配置小项按钮的显示状态
            var configBtn = categoryRow.find('button[onclick*="configItems"]');
            if (items && items.length > 0) {
                configBtn.removeClass('btn-info').addClass('btn-success');
                configBtn.find('i').removeClass('fa-cog').addClass('fa-check');
            }
        }
    }

    // 获取指定大类的小项数据
    function getCategoryItems(categoryIndex) {
        var categoryRow = $('#category-row-' + categoryIndex);
        if (categoryRow.length > 0) {
            return categoryRow.data('items') || [];
        }
        return [];
    }

    /**
     * 编辑相关
     */
    // 初始化编辑数据
    function initializeEditData() {
        var perfIndProject = [[${perfIndProject}]];
        if (perfIndProject && perfIndProject.projectId) {
            editInit = false;
            // 填充基础信息
            $('#projectId').val(perfIndProject.projectId);
            $('#deptId').val(perfIndProject.deptId);
            $('#projectName').val(perfIndProject.projectName);
            // 获取部门名称并填充
            $('#deptName').val(perfIndProject.deptName);
            // 设置岗位并触发change事件
            if (perfIndProject.postId) {
                // 等待岗位下拉框加载完成后再设置值
                setTimeout(function() {
                    $('#postId').val(perfIndProject.postId).trigger('change');
                    editInit = true;
                }, 500); // 等待岗位数据加载
            }

            // 填充分类和小项数据
            if (perfIndProject.categories && perfIndProject.categories.length > 0) {
                $.each(perfIndProject.categories, function(index, category) {
                    // 添加分类行
                    addCategoryWithValues(category.categoryName, category.scoreType, category.weight, category.sort);

                    // 如果有小项数据，存储到对应分类
                    if (category.items && category.items.length > 0) {
                        setCategoryItems(categoryIndex, category.items);
                    }
                });
            }
        }
    }

    // 带值添加分类
    function addCategoryWithValues(categoryName, scoreType, weight, sort) {
        categoryIndex++;
        var html = `        <tr id="category-row-${categoryIndex}">
                <td>${categoryIndex}</td>
                <td><input type="text" class="form-control" name="categoryName" value="${categoryName || ''}" placeholder="请输入大类名称" required autocomplete="off"></td>
                <td>
                    <select class="form-control" name="scoreType" autocomplete="off">
                        <option value="1" ${scoreType == '1' ? 'selected' : ''}>加分</option>
                        <option value="2" ${scoreType == '2' ? 'selected' : ''}>减分</option>
                        <option value="3" ${scoreType == '3' ? 'selected' : ''}>不加减分</option>
                    </select>
                </td>
                <td><input type="number" class="form-control" name="weight" min="0" max="100" placeholder="权重" value="${weight || 1}" autocomplete="off"></td>
                <td>
                    <input type="hidden" name="sort" value="${sort || categoryIndex}">
                    <button type="button" class="btn btn-info btn-xs" onclick="configItems(${categoryIndex})">
                        <i class="fa fa-cog"></i> 配置小项
                    </button>
                    <button type="button" class="btn btn-success btn-xs" onclick="moveUp(${categoryIndex})">
                        <i class="fa fa-arrow-up"></i>
                    </button>
                    <button type="button" class="btn btn-warning btn-xs" onclick="moveDown(${categoryIndex})">
                        <i class="fa fa-arrow-down"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-xs" onclick="deleteCategory(${categoryIndex})">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        $('#category-tbody').append(html);
    }

</script>
</body>
</html>
