function getUserNameByCode() {
    var params = new URL(document.location.toString()).searchParams;
    var code = params.get("code");
    $.ajax({
        url: ctx + "financial/mobile/getUserInfo",
        type: 'post',
        data: {"code": code},
        dataType: "json",
        success: function (res) {
            location.reload();
        }
    })
}

function generateFlowLine(recLines, conRecLines, finish) {
    $("#flowLine").empty();
    $("#flowLine").append('<h3 style="color: #4682b4;">流程节点:</h3>');
    for (var i=0; i<recLines.length; i++){
        var recLine = recLines[i];
        if (i == 0 || recLine.lineIndex == 0){
            var innerHtml =
                '<div class="node">\n' +
                '   <div class="node-circle-completed">'+(i+1)+'</div>\n' +
                '   <div class="node-text">'+recLine.createName+' 发起申请'+'</div>\n' +
                '</div>';
            $("#flowLine").append(innerHtml);
        }
        var operateStatus = '未处理';
        if (recLine.operateStatus == 1) {
            operateStatus = '审核通过';
            if (recLine.lineIndex == -1) operateStatus = '已处理';
        }
        if (recLine.operateStatus == 2) {
            operateStatus = '审核退回';
        }
        var innerHtml = '<div class="node">\n';
        if (finish){
            operateStatus = '已处理';
            innerHtml += '   <div class="node-circle-completed">'+(i+2)+'</div>\n';
        } else {
            if (recLine.operateStatus == 0 || !recLine.operateStatus) {
                innerHtml += '   <div class="node-circle-uncompleted">'+(i+2)+'</div>\n';
            }else{
                innerHtml += '   <div class="node-circle-completed">'+(i+2)+'</div>\n';
            }
        }
        innerHtml += '   <div class="node-text">'+recLine.operateName+' '+operateStatus+'</div>\n' +
            '</div>';
        $("#flowLine").append(innerHtml);
    }

    if (conRecLines != null && conRecLines != undefined) {
        var startIndex = recLines.length+2;
        for (var i=0; i<conRecLines.length; i++){
            var recLine = conRecLines[i];
            var innerHtml =
                '<div class="node">\n' +
                '   <div class="node-circle-uncompleted">'+(startIndex+i)+'</div>\n' +
                '   <div class="node-text">'+recLine.operateBy+' 后续流程'+'</div>\n' +
                '</div>';
            $("#flowLine").append(innerHtml);
        }
    }
}

function doSubmitFlow(ctx, recLines, conRecLines, entity, descr, hasFinal, successFunc) {
    var nodeIndex = 0;
    var flowid = 0;
    var result = {};
    if (recLines != null && recLines.length > 0){
        //已存在流程
        //获取流程id及当前步骤序号
        flowid = recLines[0].lineId;
        nodeIndex = recLines[recLines.length-1].lineIndex+1;
        $.ajax({
            url: ctx + 'system/line/userList/'+flowid+'/'+nodeIndex,
            type: 'post',
            data: {},
            dataType: "json",
            success: function (res){
                if (res && res.rows){
                    var rows = res.rows;
                    var nextUser = rows[0];
                    var confirm = "是否通过申请";
                    if (conRecLines != null && conRecLines != undefined) {
                        var nextInfo = conRecLines[0];
                        confirm = '是否通过申请，并提交给 '+nextInfo.operateBy + " " + nextUser.userName;
                    }
                    layer.confirm(confirm, {
                        title: "确认信息",
                        btn: ['确认', '取消'],
                        offset: ['30%']
                    }, function (index) {
                        var param = {};
                        param["operateStatus"] = "0";//默认新发起流程，待审核状态0
                        param["id"] = recLines[recLines.length-1].id;//当前审核记录id
                        param["operateStatus"] = "1";//通过状态
                        param["recId"] = entity.id;
                        param["recType"] = descr;
                        //当前页面用作审核页面
                        param["recUrl"] = recLines[0].recUrl;
                        param["lineId"] = flowid;
                        param["lineIndex"] = nodeIndex;
                        if (!hasFinal){
                            param["operateBy"] = nextUser.loginName;
                        }else {

                        }
                        $.ajax({
                            url: ctx + "system/line/addRecLine",
                            type: 'post',
                            data: param,
                            dataType: "json",
                            success: function (res2){
                                successFunc(res2);
                            }
                        })
                        layer.close(index);
                    });
                }
            }
        })
    }
}

function backHandler(ctx, recLines, conRecLines, entity, descr, hasFinal, successFunc) {
    layer.confirm("是否退回该申请", {
        title: "确认信息",
        btn: ['确认', '取消'],
        offset: ['30%']
    }, function (index) {
        var param = {};
        param["operateStatus"] = "2";
        param["operateBy"] = recLines[0].createBy;
        param["recId"] = entity.id;
        param["id"] = recLines[recLines.length-1].id;
        param["lineId"] = recLines[recLines.length-1].lineId;
        param["lineIndex"] = -1;
        param["recType"] = descr;
        param["recUrl"] = recLines[0].recUrl;
        param["operateContent"] = "";
        $.ajax({
            url: ctx + "system/line/addRecLine",
            type: 'post',
            data: param,
            dataType: "json",
            success: function (res){
                successFunc(res)
            }
        })
        layer.close(index);
    });
}

function downloadFile(entity, module, successFun) {
    var url = ctx + "financial/"+module+"/exportData/"+ entity.id;
    var param = {};
    var type = 'post'
    if (module == 'attendance') {
        url =  ctx + "atdform/atdstatisticform/export";
        param = {
            "starttime": entity.startdate,
            "endtime": entity.enddate,
            "deptname": entity.deptName
        }
    }
    if (module == 'sal') {
        url =  ctx + "financial/record/export/" + entity.id;
    }
    layer.confirm("确定下载该附件吗", {
        title: "确认信息",
        btn: ['确认', '取消'],
        offset: ['30%']
    }, function (index) {
        $.modal.loading("正在加载数据，请稍候...");
        $.ajax({
            url: url,
            type: type,
            data: param,
            dataType: "json",
            success: function (res){
                $.modal.closeLoading();
                successFun(res)
            },
            error: function (res) {
                $.modal.closeLoading();
            }
        })
        layer.close(index);
    });
}
